<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Racing Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="bg-gray-100 flex flex-col items-center justify-start min-h-screen p-4"
  >
    <h1 class="text-3xl font-bold mb-4 text-blue-600">Advanced Racing Game</h1>

    <canvas
      id="gameCanvas"
      width="800"
      height="600"
      class="border border-gray-300 rounded mb-4"
    ></canvas>

    <div
      id="controls"
      class="bg-white rounded-lg shadow-lg p-6 w-full max-w-3xl mt-4"
    >
      <button
        id="startButton"
        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded"
      >
        Start
      </button>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <h2 class="text-xl font-semibold mb-2 text-red-600">Car 1 (Red)</h2>
          <div class="mb-2">
            <label for="speed1" class="block text-sm font-medium text-gray-700"
              >Speed:</label
            >
            <input
              type="range"
              id="speed1"
              min="1"
              max="5"
              step="0.5"
              value="2"
              class="w-full"
            />
            <span id="speed1Value" class="text-sm text-gray-600">2</span>
          </div>
          <div id="car1Stats" class="text-sm text-gray-600"></div>
        </div>
        <div>
          <h2 class="text-xl font-semibold mb-2 text-blue-600">Car 2 (Blue)</h2>
          <div class="mb-2">
            <label for="speed2" class="block text-sm font-medium text-gray-700"
              >Speed:</label
            >
            <input
              type="range"
              id="speed2"
              min="1"
              max="5"
              step="0.5"
              value="2"
              class="w-full"
            />
            <span id="speed2Value" class="text-sm text-gray-600">2</span>
          </div>
          <div id="car2Stats" class="text-sm text-gray-600"></div>
        </div>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const speed1Slider = document.getElementById("speed1");
      const speed2Slider = document.getElementById("speed2");
      const speed1Value = document.getElementById("speed1Value");
      const speed2Value = document.getElementById("speed2Value");
      const startButton = document.getElementById("startButton");
      const car1Stats = document.getElementById("car1Stats");
      const car2Stats = document.getElementById("car2Stats");

      let isZoomedIn = false;
      let zoomLevel = 0.3;

      let countdown = 0;
      let countdownInterval;

      let car1 = {
        x: 50,
        y: 300,
        speed: 2,
        angle: 0,
        baseSpeed: 2,
        slowdownTimer: 0,
        acceleration: 1,
        slowdownFactor: 0.1,
        driftFactor: 0.15,
      };
      let car2 = {
        x: 50,
        y: 320,
        speed: 2,
        angle: 0,
        baseSpeed: 2,
        slowdownTimer: 0,
        acceleration: 0.5,
        slowdownFactor: 0.2,
        driftFactor: 0.15,
      };
      let gameStarted = false;
      let winner = null;
      let track = [];
      let lastTimestamp = 0;

      function generateTrack() {
        track = [];
        let x = 50;
        let y = canvas.height / 2;
        let angle = 0;
        let lastDirection = 0;
        track.push({ x, y });

        while (x < canvas.width * 3) {
          const length = Math.random() * 30 + 20;
          const direction =
            Math.random() < 0.7 ? lastDirection : Math.random() < 0.5 ? 1 : -1;

          if (direction === 0) {
            angle = 0;
          } else {
            angle = direction * (Math.PI / 6 + (Math.random() * Math.PI) / 6);
          }

          x += Math.cos(angle) * length;
          y += Math.sin(angle) * length;

          if (y < 50) {
            y = 50;
            lastDirection = 1;
          } else if (y > canvas.height - 50) {
            y = canvas.height - 50;
            lastDirection = -1;
          } else {
            lastDirection = direction;
          }

          track.push({ x, y });
        }

        track.push({ x: canvas.width * 3 + 50, y: canvas.height / 2 });
      }

      function drawTrack() {
        ctx.save();
        if (!gameStarted) {
          // Calculate the scale to fit the entire track
          const trackWidth = track[track.length - 1].x - track[0].x;
          const trackHeight = canvas.height;
          const scale =
            Math.min(canvas.width / trackWidth, canvas.height / trackHeight) *
            0.9;

          ctx.scale(scale, scale);
          ctx.translate(
            -track[0].x + (canvas.width / scale - trackWidth) / 2,
            (canvas.height / scale - trackHeight) / 2
          );
        } else {
          ctx.translate(-car1.x + 200, 0);
        }
        // Draw main track
        ctx.beginPath();
        ctx.moveTo(track[0].x, track[0].y);
        for (let i = 1; i < track.length - 2; i++) {
          const xc = (track[i].x + track[i + 1].x) / 2;
          const yc = (track[i].y + track[i + 1].y) / 2;
          ctx.quadraticCurveTo(track[i].x, track[i].y, xc, yc);
        }
        ctx.quadraticCurveTo(
          track[track.length - 2].x,
          track[track.length - 2].y,
          track[track.length - 1].x,
          track[track.length - 1].y
        );
        ctx.strokeStyle = "#6d706d";
        ctx.lineWidth = 20;
        ctx.stroke();

        // Draw dashed white line
        ctx.beginPath();
        ctx.setLineDash([20, 20]); // This creates a dashed line pattern: 20px dash, 20px gap
        ctx.moveTo(track[0].x, track[0].y);
        for (let i = 1; i < track.length - 2; i++) {
          const xc = (track[i].x + track[i + 1].x) / 2;
          const yc = (track[i].y + track[i + 1].y) / 2;
          ctx.quadraticCurveTo(track[i].x, track[i].y, xc, yc);
        }
        ctx.quadraticCurveTo(
          track[track.length - 2].x,
          track[track.length - 2].y,
          track[track.length - 1].x,
          track[track.length - 1].y
        );
        ctx.strokeStyle = "#FFF";
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.setLineDash([]); // Reset to solid line

        // Draw start circle
        ctx.beginPath();
        ctx.arc(track[0].x, track[0].y, 15, 0, Math.PI * 2);
        ctx.fillStyle = "#FFF";
        ctx.fill();

        // Draw finish circle
        ctx.beginPath();
        ctx.arc(
          track[track.length - 1].x,
          track[track.length - 1].y,
          15,
          0,
          Math.PI * 2
        );
        ctx.fillStyle = "#FFF";
        ctx.fill();

        ctx.fillStyle = "#FFF";
        ctx.font = "20px Arial";
        ctx.fillText("START", track[0].x - 30, track[0].y - 20);

        ctx.fillStyle = "#FFF";
        ctx.font = "20px Arial";
        ctx.fillText(
          "FINISH",
          track[track.length - 1].x - 30,
          track[track.length - 1].y - 20
        );

        ctx.restore();
      }

      function drawCar(car, color) {
        if (gameStarted) {
          ctx.save();
          ctx.translate(car.x - car1.x + 200, car.y);
          ctx.rotate(car.angle);
          ctx.fillStyle = color;
          ctx.fillRect(-8, -5, 16, 10);
          ctx.restore();
        }
      }

      function pointToLineDistance(point, lineStart, lineEnd) {
        const A = point.x - lineStart.x;
        const B = point.y - lineStart.y;
        const C = lineEnd.x - lineStart.x;
        const D = lineEnd.y - lineStart.y;

        const dot = A * C + B * D;
        const lenSq = C * C + D * D;
        let param = dot / lenSq;

        let xx, yy;

        if (param < 0) {
          xx = lineStart.x;
          yy = lineStart.y;
        } else if (param > 1) {
          xx = lineEnd.x;
          yy = lineEnd.y;
        } else {
          xx = lineStart.x + param * C;
          yy = lineStart.y + param * D;
        }

        const dx = point.x - xx;
        const dy = point.y - yy;
        return Math.sqrt(dx * dx + dy * dy);
      }

      function distanceToTrack(car) {
        let minDist = Infinity;
        for (let i = 0; i < track.length - 1; i++) {
          const p1 = track[i];
          const p2 = track[i + 1];
          const d = pointToLineDistance(car, p1, p2);
          if (d < minDist) minDist = d;
        }
        return minDist;
      }

      function updateCar(car, deltaTime) {
        if (gameStarted && !winner && countdown === 0) {
          let minDist = Infinity;
          let nearestPoint;
          for (let point of track) {
            const dist = Math.hypot(car.x - point.x, car.y - point.y);
            if (dist < minDist) {
              minDist = dist;
              nearestPoint = point;
            }
          }

          const currentIndex = track.indexOf(nearestPoint);
          const nextPoint = track[Math.min(currentIndex + 1, track.length - 1)];

          let targetAngle = Math.atan2(
            nextPoint.y - car.y,
            nextPoint.x - car.x
          );

          let angleDiff = targetAngle - car.angle;
          if (angleDiff > Math.PI) angleDiff -= 2 * Math.PI;
          if (angleDiff < -Math.PI) angleDiff += 2 * Math.PI;
          car.angle += angleDiff * 0.1;

          car.angle +=
            (Math.random() - 0.5) *
            car.driftFactor *
            (car.speed / car.baseSpeed);

          if (distanceToTrack(car) > 8 && car.slowdownTimer === 0) {
            car.speed = car.baseSpeed * car.slowdownFactor;
            car.slowdownTimer = 1000;
          }

          if (car.slowdownTimer > 0) {
            car.slowdownTimer -= deltaTime;
            if (car.slowdownTimer <= 0) {
              car.slowdownTimer = 0;
              car.speed = Math.min(
                car.baseSpeed,
                car.speed + car.acceleration * (deltaTime / 1000)
              );
            }
          } else if (car.speed < car.baseSpeed) {
            car.speed = Math.min(
              car.baseSpeed,
              car.speed + car.acceleration * (deltaTime / 1000)
            );
          }

          car.x += Math.cos(car.angle) * car.speed;
          car.y += Math.sin(car.angle) * car.speed;

          if (car.x >= track[track.length - 1].x) {
            winner = car === car1 ? "Car 1 (Red)" : "Car 2 (Blue)";
          }
        }
      }

      function updateGame(timestamp) {
        let deltaTime = timestamp - lastTimestamp;
        lastTimestamp = timestamp;

        updateCar(car1, deltaTime);
        updateCar(car2, deltaTime);

        updateCarStats();
      }

      function updateCarStats() {
        car1Stats.innerHTML = `
                Current Speed: ${car1.speed.toFixed(2)}<br>
                Acceleration: ${car1.acceleration.toFixed(2)}<br>
                Slowdown Factor: ${car1.slowdownFactor.toFixed(2)}<br>
                Drift Factor: ${car1.driftFactor.toFixed(2)}
            `;
        car2Stats.innerHTML = `
                Current Speed: ${car2.speed.toFixed(2)}<br>
                Acceleration: ${car2.acceleration.toFixed(2)}<br>
                Slowdown Factor: ${car2.slowdownFactor.toFixed(2)}<br>
                Drift Factor: ${car2.driftFactor.toFixed(2)}
            `;
      }

      function updateZoom() {
        if (gameStarted && zoomLevel < 1) {
          zoomLevel = Math.min(1, zoomLevel + 0.01);
        }
      }

      function drawGame() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // Заполняем весь canvas зеленым цветом
        ctx.fillStyle = "#87b080"; // Зеленый цвет, похожий на траву
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        drawTrack();

        if (gameStarted) {
          drawCar(car1, "red");
          drawCar(car2, "blue");
          if (countdown > 0) {
            ctx.fillStyle = 'black';
            ctx.font = '64px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(countdown, canvas.width / 2, canvas.height / 2);
          }
        }

        if (winner) {
          ctx.fillStyle = "black";
          ctx.font = "32px Arial";
          ctx.fillText(`${winner} wins!`, 350, 200);
        }
      }

      function gameLoop(timestamp) {
        updateGame(timestamp);
        updateZoom();
        drawGame();
        requestAnimationFrame(gameLoop);
      }

      startButton.addEventListener("click", () => {
        if (!gameStarted) {
          gameStarted = true;
          zoomLevel = 0.3;
          isZoomedIn = true;
          car1 = {
            x: track[0].x,
            y: track[0].y - 4,
            speed: parseFloat(speed1Slider.value),
            angle: 0,
            baseSpeed: parseFloat(speed1Slider.value),
            slowdownTimer: 0,
            acceleration: 1,
            slowdownFactor: 0.1,
            driftFactor: 0.15,
          };
          car2 = {
            x: track[0].x,
            y: track[0].y + 4,
            speed: parseFloat(speed2Slider.value),
            angle: 0,
            baseSpeed: parseFloat(speed2Slider.value),
            slowdownTimer: 0,
            acceleration: 0.5,
            slowdownFactor: 0.2,
            driftFactor: 0.15,
          };
          winner = null;
          startButton.textContent = "Restart";
          speed1Slider.disabled = true;
          speed2Slider.disabled = true;

          countdown = 3;
          countdownInterval = setInterval(() => {
            countdown--;
            if (countdown === 0) {
              clearInterval(countdownInterval);
              gameStarted = true;
            }
          }, 300);
        } else {
          clearInterval(countdownInterval);
          countdown = 0;
          generateTrack();
          gameStarted = false;
          isZoomedIn = false;
          startButton.textContent = "Start";
          speed1Slider.disabled = false;
          speed2Slider.disabled = false;
        }
      });

      speed1Slider.addEventListener("input", () => {
        speed1Value.textContent = speed1Slider.value;
        if (!gameStarted) {
          car1.baseSpeed = parseFloat(speed1Slider.value);
          car1.speed = car1.baseSpeed;
          updateCarStats();
        }
      });

      speed2Slider.addEventListener("input", () => {
        speed2Value.textContent = speed2Slider.value;
        if (!gameStarted) {
          car2.baseSpeed = parseFloat(speed2Slider.value);
          car2.speed = car2.baseSpeed;
          updateCarStats();
        }
      });

      generateTrack();
      drawGame();
      updateCarStats();
      requestAnimationFrame(gameLoop);
    </script>
  </body>
</html>
